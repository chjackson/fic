---
title: "Using the fic R package for focused model comparison"
date: "`r Sys.Date()`"
author: Chris Jackson <chris.jackson@mrc-bsu.cam.ac.uk>
output: 
  html_document: 
    includes:
      before_body: fic.sty  
  code_folding: show
vignette: >
 %\VignetteIndexEntry{Using the fic R package for focused model comparison}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteDepends{fic,ggplot2}
 %\VignetteEncoding{UTF-8}
bibliography: fic.bib
---

This vignette shows how to use the `fic` package through 2 or 3 examples. 

Work in progress!

## Example: covariate selection in logistic regression 


This example is used by @claeskens:hjort:book (Example 6.1) to illustrate the focused information criterion.  The dataset was originally presented by @hosmer:lemeshow:firstedition. Data are taken from $n=189$ women with newborn babies, and the binary outcome is whether the baby is born with a weight less than 2500g.   We build a logistic regression model to predict the outcome, but are uncertain about what covariates should be included. 

The data are provided as an object `birthwt` in the `fic` package.  This is the same as `birthwt` in `MASS` @venables:ripley with the addition of a few extra columns defining interactions and transformations as in @claeskens:hjort:book. 

The following covariates are always included (coefficient vector $\btheta$)

* $x_1$ Weight of mother in kg, `lwtkg`

The following covariates will be selected from (coefficient vector $\bgamma$)

* $z_1$ age, in years, `age`

* $z_2$ indicator for smoking, `smoke`

* $z_3$ history of hypertension, `ht`

* $z_4$ uterine irritability, `ui`

* interaction $z_5 = z_1 z_2$ between smoking and age, `smokeage`

* interaction $z_6 = z_2 z_4$ between smoking and uterine irritability, `smokeui`


## Defining the wide model and the focus function

Firstly the wide model is defined and fitted.  

```{r}
library(fic)
wide.glm <- glm(low ~ lwtkg + age + smoke + ht + ui + smokeage + smokeui, data=birthwt, family=binomial)
```

The *focus function* is then defined.  This should be an R function, mapping the parameters `par` of the wide model to the quantity of interest.   The focus can optionally have an second argument.  If supplied, this must be called `X`, and can be used to supply covariate values at which the focus function should be evaluated.  Here we take the probability of low birth weight as the focus, for two covariate categories: 
 
1. smokers with average or typical values of the other covariates.  These values are given in the order supplied when specifying the model (for smokers: intercept, `lwtkg`=58.24, `age`=22.95, `smoke`=1, `ht`=0, `ui`=0, `smokeage`=22.95, `smokeui`=0).

2. non-smokers with average values of the other covariates

```{r}
focus <- function(par, X)plogis(X %*% par)
vals.smoke <-    c(1, 58.24, 22.95, 1, 0, 0, 22.95, 0)
vals.nonsmoke <- c(1, 59.50, 23.43, 0, 0, 0, 0, 0)
X <- rbind(vals.smoke, vals.nonsmoke)
```

We can illustrate these functions by calculating the probability of low birth weight, under the wide model, for each group.  Note this is about twice as high for smokers. 
```{r}
focus(coef(wide.glm), X=X)
```


### Comparing a small number of submodels 

The `fic` function can then be used to calculate the mean square error of the focus for one or more given submodels.  For example, compare two models, both including maternal weight, one including age and smoking, but the other including age, smoking and hypertension. 

```{r}
mod1.glm <- glm(low ~ lwtkg + age + smoke, data=birthwt, family=binomial)
mod2.glm <- glm(low ~ lwtkg + age + smoke + ht, data=birthwt, family=binomial)
```

We supply the following arguments to the `fic` function.

* `wide` the fitted wide model.  All the model fit statistics are computed using the estimates and covariance matrix from this model.   `fic` will automatically recognise that this is a GLM fitted by the `glm` function in R, and extract the relevant information. 

* `sub` the fitted submodel to be assessed.  This is optional, and is only needed so that the results from `fic` can include the estimate of the focus under this model.

* `inds` indicators for which parameters are included in the submodel, that is, which elements of $(\btheta,\bgamma)$ are fixed to $\bgamma_0$. This should have length equal to $dim(\btheta) + dim(\bgamma)$, the total number of parameters in the wide model, and contain 1s in the positions where the parameter is included in the submodel, and 0s in positions where the parameter is excluded.  This should be 1 in the positions defining the narrow model as specified in `inds0` below.

* `inds0` indicators for which parameters are included in the narrow model, in the same format as \code{inds}.

* `focus` the focus function. 

We can then call `fic` for each of the two models.  This returns an object containing the model fit statistics and the estimate of the focus quantity for each model. 

```{r}
inds0 <- c(1,1,0,0,0,0,0,0)
inds1 <- c(1,1,1,1,0,0,0,0)
inds2 <- c(1,1,1,1,1,0,0,0)
fic1 <- fic(wide=wide.glm, sub=mod1.glm, inds=inds1, inds0=inds0, focus=focus, X=X)
fic2 <- fic(wide=wide.glm, sub=mod2.glm, inds=inds2, inds0=inds0, focus=focus, X=X)
fic1
fic2
```



TODO explain the different components of `res` 


### Lower-level way of calling `fic` which works for any model class 

Above, the `fic` function recognised the fitted model objects as GLMs.  But the package can be used to calculate
focused model comparison statistics for any class of models, not just the special classes it recognises.  We can illustrate this for `mod1.glm` above by removing its `glm` class.   Calling the generic `fic` function in this case will call the "default" method `fic.default`, instead of the method `fic.glm`.  For this, we need to supply the parameter estimates $(\hat\btheta, \hat\bgamma)$ and scaled information matrix $J$.   Optionally we can also supply arguments `parsub` giving the parameter estimates under the submodel, and `gamma0` ($\gamma_0$, the special value taken by elements of $\bgamma$ that are excluded in the submodel, which defaults to 0), so that the focus estimate under the submodel can be appended to the results. 

```{r}
par <- coef(wide.glm)
J <- solve(vcov(wide.glm))/nrow(birthwt)
fic(par=par, J=J,  inds=inds1, inds0=inds0, n=nrow(birthwt), focus=focus, X=X, parsub=coef(mod1.glm))
```



### Testing an automatically-defined set of models 

TODO something to make this easier?   Could go into separate vignette if this gets too long. Separate package features vs user tips.

The following code creates a matrix of indicators for all possible covariate selections between the narrow and wide models.  Models with interactions but not both corresponding main effects are excluded.  Two alternative sets of names for the models are created.  
```{r}
combs <- expand.grid(age=c(0,1), smoke=c(0,1), ht=c(0,1), ui=c(0,1), smokeage=c(0,1), smokeui=c(0,1))
combs <- as.matrix(with(combs,
                        combs[!((smoke==0 & smokeage==1) |
                                (smoke==0 & smokeui==1) |
                                (age==0 & smokeage==1) |
                                (ui==0 & smokeui==1)),]))
rownames(combs) <- apply(combs, 1, paste, collapse="")
namesfull <- apply(combs, 1, function(x)paste(colnames(combs)[x==1], collapse=","))
```

The following function calculates the focused model comparison statistics for all of these models, for a focus defined by the probability of low birth weight at covariate values defined by `X`.

TODO annotate this more 


```{r,warning=FALSE}
Xobs <- with(birthwt, cbind(intercpt, lwtkg))
Zobs <- with(birthwt, cbind(age, smoke, ht, ui, smokeage, smokeui))

res <- array(dim=c(nrow(X), nrow(combs), 9))
for (i in 1:nrow(combs)){
  XZi <- cbind(Xobs, Zobs[,which(combs[i,]==1)])
  sub.glm <- glm(low ~ XZi - 1, data=birthwt, family=binomial)
  ficres <- fic(wide=wide.glm, sub=sub.glm, 
                inds=c(1,1,combs[i,]), inds0=inds0, focus=focus, X=X)
  res[,i,] <- ficres
}
dimnames(res) <- list(rownames(X), rownames(combs), colnames(ficres))
```

Explain why there are NaNs.

Then show how to plot them. TODO condition on tidyverse as suggests packages.  TODO annotate/simplify
TODO compare smokers vs non.  ggplot facet/grid? 

```{r,message=FALSE}
library(tidyverse)
```

```{r}
ress <- as.data.frame(res["vals.smoke",,]) %>% 
  mutate(l95 = focus - qnorm(0.975)*se,
         u95 = focus + qnorm(0.975)*se,
         namesfull = namesfull) %>% 
  filter(!is.nan(rmse)) %>%
  arrange(desc(rmse)) %>%
  mutate(aic.rank = rank(AIC),
         bic.rank = rank(BIC))

mod_wide <-  namesfull[rowSums(combs)==ncol(combs)]
ress_wide <- ress[ress$namesfull==mod_wide,]
mods_exc_smoke <- c(mod_wide, 
                    "smoke",
                    "smoke,ui,smokeui",
                    "age,smoke,ht,ui,smokeui",
                    "smoke,ht,ui",
                    "smoke,ui",
                    "smoke,ht",
                    "age,smoke,ht"
                    )

ps <- ress %>% filter(!namesfull %in% mods_exc_smoke) %>% 
  ggplot(aes(x=focus, y=rmse)) +
  xlim(0, 0.6) + 
  xlab("Probability of low birth weight") +
  ylab("Root mean square error of estimate") + 
  geom_point() +
  geom_segment(aes(x=l95, xend=u95, yend=rmse)) +
  geom_point(data=ress_wide, col="red") +
  geom_segment(aes(x=l95, xend=u95, yend=rmse), data=ress_wide, col="red") +
  geom_text(aes(x=0, label=mod_wide, hjust=0), data=ress_wide, col="red", size=5) +
  #  geom_point(aes(x = focus - bias), col="red") +
  geom_text(aes(x=0, label=namesfull, hjust=0)) +
  geom_vline(aes(xintercept = as.numeric(plogis(coef(wide.glm) %*% vals.smoke))),
             col="red") +
  theme(text = element_text(size=20),
        axis.text.x = element_text(size=20)) +
  geom_text(aes(x=0.35, y= 0.08, label="Estimate from wide model", hjust=0), col="red") +
  geom_text(aes(x=0, y=0.047, label="Models with lowest MSE", hjust=0), col="blue") +
  geom_text(aes(x=0, y=0.085, label="Models with highest MSE", hjust=0), col="blue") +
  geom_text(aes(x=0.55, label=aic.rank), size=4) + 
  geom_text(data=ress_wide, aes(x=0.55, label=aic.rank), size=5, col="red") +
  geom_text(aes(x=0.57, y=0.093, label="Ranks of:")) + 
  geom_text(aes(x=0.55, y=0.091, label="AIC")) +
  geom_text(aes(x=0.6, label=bic.rank), size=4) + 
  geom_text(data=ress_wide, aes(x=0.6, label=bic.rank), size=5, col="red") +
  geom_text(aes(x=0.6, y=0.091, label="BIC")) 
ps
```



### Average FIC over a range of focuses 

TODO 


### Other model classes 

Survival 

Multi-state

???

