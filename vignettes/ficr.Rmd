---
title: "Using the fic R package for focused model comparison"
date: "`r Sys.Date()`"
author: Chris Jackson <chris.jackson@mrc-bsu.cam.ac.uk>
output: 
  html_document: 
    includes:
      before_body: fic.sty  
  code_folding: show
vignette: >
 %\VignetteIndexEntry{Using the fic R package for focused model comparison}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteDepends{fic,ggplot2}
 %\VignetteEncoding{UTF-8}
bibliography: fic.bib
---

This vignette shows how to use the `fic` package through 2 or 3 examples. 

Work in progress!

## Example: covariate selection in logistic regression 


This example is used by @claeskens:hjort:book (Example 6.1) to illustrate the focused information criterion.  The dataset was originally presented by @hosmer:lemeshow:firstedition. Data are taken from $n=189$ women with newborn babies, and the binary outcome is whether the baby is born with a weight less than 2500g.   We build a logistic regression model to predict the outcome, but are uncertain about what covariates should be included. 

The data are provided as an object `birthwt` in the `fic` package.  This is the same as `birthwt` in `MASS` @venables:ripley with the addition of a few extra columns defining interactions and transformations as in @claeskens:hjort:book. 

The following covariates are always included (coefficient vector $\btheta$)

* $x_1$ Weight of mother in kg, `lwtkg`

The following covariates will be selected from (coefficient vector $\bgamma$)

* $z_1$ age, in years, `age`

* $z_2$ indicator for smoking, `smoke`

* $z_3$ history of hypertension, `ht`

* $z_4$ uterine irritability, `ui`

* interaction $z_5 = z_1 z_2$ between smoking and age, `smokeage`

* interaction $z_6 = z_2 z_4$ between smoking and uterine irritability, `smokeui`


## Defining the wide model and the focus function

Firstly the wide model is defined and fitted.  

```{r}
library(fic)
wide.glm <- glm(low ~ lwtkg + age + smoke + ht + ui + smokeage + smokeui, data=birthwt, family=binomial)
```

The *focus function* is then defined.  This should be an R function, mapping the parameters `par` of the wide model to the quantity of interest.   The focus can optionally have an second argument.  If supplied, this must be called `X`, and can be used to supply covariate values at which the focus function should be evaluated.  Here we take the probability of low birth weight as the focus, for two covariate categories: 
 
1. smokers with average or typical values of the other covariates.  These values are given in the order supplied when specifying the model (for smokers: intercept, `lwtkg`=58.24, `age`=22.95, `smoke`=1, `ht`=0, `ui`=0, `smokeage`=22.95, `smokeui`=0).

2. non-smokers with average values of the other covariates

```{r}
focus <- function(par, X)plogis(X %*% par)
vals.smoke <-    c(1, 58.24, 22.95, 1, 0, 0, 22.95, 0)
vals.nonsmoke <- c(1, 59.50, 23.43, 0, 0, 0, 0, 0)
X <- rbind(vals.smoke, vals.nonsmoke)
```

We can illustrate these functions by calculating the probability of low birth weight, given the parameters of the fitted wide model, for each group.  Note this is about twice as high for smokers. 
```{r}
focus(coef(wide.glm), X=X)
```


### Comparing a small number of submodels 

The `fic` function can then be used to calculate the mean square error of the focus for one or more given submodels.  For example, compare two models, both including maternal weight, one including age and smoking, but the other including age, smoking and hypertension. 

```{r}
mod1.glm <- glm(low ~ lwtkg + age + smoke, data=birthwt, family=binomial)
mod2.glm <- glm(low ~ lwtkg + age + smoke + ht, data=birthwt, family=binomial)
```

We supply the following arguments to the `fic` function.

* `wide` the fitted wide model.  All the model fit statistics are computed using the estimates and covariance matrix from this model.   `fic` will automatically recognise that this is a GLM fitted by the `glm` function in R, and extract the relevant information. 

* `inds` indicators for which parameters are included in the submodel, that is, which elements of $(\btheta,\bgamma)$ are fixed to $\bgamma_0$.  This should have number of rows equal to the number of submodels to be assessed, and number of columns equal to $dim(\btheta) + dim(\bgamma)$, the total number of parameters in the wide model.  It contains 1s in the positions where the parameter is included in the submodel, and 0s in positions where the parameter is excluded.  This should always be 1 in the positions defining the narrow model, as specified in `inds0` below.
If just one submodel is to be assessed, `inds` can also be supplied as a vector of length $dim(\btheta) + dim(\bgamma)$. 

* `inds0` vector of indicators for which parameters are included in the narrow model, in the same format as `inds`.  This can be omitted, in which case the narrow model is assumed to be given by the first row of `inds`.

* `focus` the focus function. 

* `sub` a list of the fitted submodels to be assessed.  This is optional, and is only needed so that the results from `fic` can include the estimate of the focus under the submodels.  Note, if just one submodel is to be assessed, this should still be enclosed in a list, e.g. `list(mod1.glm)`. 

The main `fic` function then returns an object containing the model fit statistics and the estimate of the focus quantity for each model. 

```{r}
inds <- rbind(mod1 = c(1,1,1,1,0,0,0,0),
              mod2 = c(1,1,1,1,1,0,0,0))
inds0 <- c(1,1,0,0,0,0,0,0)
sub <- list(mod1.glm, mod2.glm)
fic1 <- fic(wide=wide.glm, inds=inds, inds0=inds0, focus=focus, X=X, sub=sub)
fic1
```

TODO explain the different components of `res` 


### Calling `fic` for an unfamiliar class of models 

Above, the `fic` function recognised the fitted model objects as GLMs, that is, objects of class `"glm"` returned by the `glm()` function in base R.
But the package can be used to calculate focused model comparison statistics for any class of models, not just the special classes it recognises. To do this, it needs to know where three things are stored inside the fitted model objects (TODO REFER TO FIC NOTATION)

1. `coef`: the vector of maximum likelihood estimates 

2. `nobs`: the number of observations contributing to the model fit 

3. `vcov`: the covariance matrix of the maximum likelihood estimates.  

Given a fitted model object called `mod`, the `fic()` function assumes by default that `coef(mod)`, `nobs(mod)` and `vcov(mod)` respectively return these pieces of information.  If one or more of these assumptions is not true, the defaults can be changed by supplying the argument `fns` to `fic()`, which should be a named list of three components.  Each component should be a function with one argument (the fitted model) which extracts the required information from the fitted model and returns it.  For example, the first component of the list below is a function which, when applied to a `glm` object, returns the maximum likelihood estimates of the regression coefficients.  (TODO better explained with a more obscure class?)

```{r}
fns <- list(coef = function(x)coef(x),
            nobs = function(x)nobs(x),
            vcov = function(x)vcov(x))
fic1 <- fic(wide=wide.glm, inds=inds, inds0=inds0, focus=focus, fns=fns, X=X, sub=sub)
```


### Built-in model classes supported 

Refer to a list of vignettes. 

Simple linear models, focus as expected outcome at particular covariate value.  mtcars example, in rd doc or vignette

Survival models with flexsurvreg and survreg 


### Testing an automatically-defined set of models 

The following code creates a matrix of indicators for all possible covariate selections between the narrow and wide models.    
```{r}
combs <- expand.grid(intercept=1, lwtkg=1, age=c(0,1), smoke=c(0,1), ht=c(0,1), ui=c(0,1), smokeage=c(0,1), smokeui=c(0,1))
```

We can supply this to fic to run fic for all combinations of included / excluded parameters
The following function calculates the focused model comparison statistics for all of these models, for a focus defined by the probability of low birth weight at covariate values defined by `X`.

```{r}
ficres <- fic(wide=wide.glm, inds=combs, inds0=inds0, focus=focus, X=X)
```

However some of these models may not make sense. 
Models with interactions but not both corresponding main effects are then excluded.  
Two alternative sets of names for the models are also created 

```{r}
combs <- with(combs,
              combs[!((smoke==0 & smokeage==1) |
                      (smoke==0 & smokeui==1) |
                      (age==0 & smokeage==1) |
                      (ui==0 & smokeui==1)),])
rownames(combs) <- apply(combs, 1, paste, collapse="")
namesfull <- apply(combs, 1, function(x)paste(colnames(combs)[x==1], collapse=","))
ficres <- fic(wide=wide.glm, inds=combs, inds0=inds0, focus=focus, X=X)
```

We can actually fit the submodels in a loop by forming a covariate matrix, and subsetting its columns at each iteration.   The list of fitted models can then be passed to the fic function so that so that the focus estimate is displayed alongside the fic results. 

```{r,warning=FALSE}
Xobs <- with(birthwt, cbind(intercpt, lwtkg))
Zobs <- with(birthwt, cbind(age, smoke, ht, ui, smokeage, smokeui))
nmod <- nrow(combs)
sub <- vector(nmod, mode="list")
for (i in 1:nmod){
  XZi <- cbind(Xobs, Zobs)[,which(combs[i,]==1)]
  sub[[i]] <- glm(low ~ XZi - 1, data=birthwt, family=binomial)
}
ficres <- fic(wide=wide.glm, inds=combs, inds0=inds0, focus=focus, X=X, sub=sub)
ficres
```


TODO Explain why there are NaNs.

Then show how to plot them. TODO condition on ggplot2.  TODO annotate/simplify.

```{r,message=FALSE}
library(ggplot2)
```

```{r}
ress <- within(ficres,{
  l95 = focus - qnorm(0.975)*se
  u95 = focus + qnorm(0.975)*se
})
ress <- subset(ress, !is.nan(ress$rmse))
ress <- ress[order(ress$rmse, decreasing=TRUE),]
ress_wide <- ress[ress$mods=="11111111",]
wide_est <- focus(coef(wide.glm), X)
ress$wide_est <- wide_est[match(ress$vals, rownames(wide_est))]

ps <- ggplot(ress[ress$mods!="11111111",],
         aes(x=focus, y=rmse)) +
  facet_grid(.~vals) + 
  xlim(0, 0.6) + 
  xlab("Probability of low birth weight") +
  ylab("Root mean square error of estimate") + 
  geom_point() +
  geom_segment(aes(x=l95, xend=u95, yend=rmse)) +
  geom_point(data=ress_wide, col="red") +
  geom_segment(aes(x=l95, xend=u95, yend=rmse), data=ress_wide, col="red") +
  geom_text(aes(x=0, label="11111111", hjust=0), data=ress_wide, col="red", size=5) +
  geom_text(aes(x=0, label=mods, hjust=0)) +
  geom_vline(aes(xintercept = wide_est), col="red") +
  theme(text = element_text(size=20),
        axis.text.x = element_text(size=20)) +
  geom_text(aes(x=wide_est, y= 0.12, label="Estimate from wide model", hjust=0), col="red") 
ps
```



### Average FIC over a range of focuses 

TODO 


### Other model classes 

Survival (see separate survival vignette for now)

Multi-state

???

