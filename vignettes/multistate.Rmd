---
title: "Using the fic R package for focused model comparison: multi-state models"
date: "`r Sys.Date()`"
author: Chris Jackson <chris.jackson@mrc-bsu.cam.ac.uk>
output: 
  html_document: 
    includes:
      before_body: fic.sty  
  code_folding: show
vignette: >
 %\VignetteIndexEntry{Using the fic R package for focused model comparison: multi-state models}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteDepends{fic,ggplot2}
 %\VignetteEncoding{UTF-8}
bibliography: fic.bib
---

Requires the development version of msm to 

## Focused model comparison for covariate selection in multi-state models fitted with msm 

Example dataset in package, `psor`.  Four state progression-only model.

Wide model: model with two binary covariates associated with different effects for all three transition rates.

```{r}
library(msm)
psor.q <- rbind(c(0,0.1,0,0), c(0,0,0.1,0), c(0,0,0,0.1), c(0,0,0,0))
psor.wide.msm <- msm::msm(state ~ months, subject=ptnum, data=msm::psor, qmatrix = psor.q,  covariates = ~ollwsdrt+hieffusn, control=list(fnscale=1))
psor.wide.msm
```

Focus: total length of stay in state 4 up to 10 years for people without `ollwsdrt` or `hieffusn`.

This requires the development version of `msm`, currently available from github.  This includes the `updatepars.msm` function for altering the point estimates from a fitted model a model to a vector of values supplied by the user.  This allows functions such as `totlos.msm` to be used, which define complicated functions of the model parameters.

```{r}
#install_github("chjackson/msm") # if necessary 
focus_tlos <- function(pars){
    x.new <- msm::updatepars.msm(psor.wide.msm, pars)
    msm::totlos.msm(x.new, covariates=0, t=10)["State 4"]
}
```

We assess the wide model and six further submodels.

```{r}
inds0 <- c(1,1,1,0,0,0,0,0,0) # intercepts always included
inds <- rbind(
    c(1,1,1,1,1,1,1,1,1),
    c(1,1,1,0,1,1,1,1,1),
    c(1,1,1,0,0,1,1,1,1),
    c(1,1,1,0,0,0,1,1,1),
    c(1,1,1,0,0,0,0,1,1),
    c(1,1,1,0,0,0,0,0,1),
    c(1,1,1,0,0,0,0,0,0))
fic(wide=psor.wide.msm, inds=inds, inds0=inds0, focus=focus_tlos)
```

Very small biases in all cases.  RMSE goes down with the variance as covariates are omitted.

I guess because these covariates are not strongly associated with transition rates. 
